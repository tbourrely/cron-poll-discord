name: get poll instance with multiple instances
vars:
  api: http://localhost:3000
  poll_id: 1ff4f04d-b820-4f77-a81b-83232a4a3477

testcases:
  - name: Clean db
    steps:
      - type: exec
        script: sqlx database reset -fy --source ../migrations

  - name: Setup fixtures
    steps:
      - type: dbfixtures
        database: postgres
        dsn: postgres://postgres:postgres@localhost/polls?sslmode=disable
        folder: "fixtures/instances/multiple"

  - name: GET polls should not be empty
    steps:
      - type: http
        method: GET
        url: "{{.api}}/polls"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson ShouldHaveLength 1

  - name: GET polls instances should not be empty
    steps:
      - type: http
        method: GET
        url: "{{.api}}/polls/{{.poll_id}}/instances"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson ShouldHaveLength 2

  - name: First poll instance should have 2 answers
    steps:
      - type: http
        method: GET
        url: "{{.api}}/polls/{{.poll_id}}/instances/1"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.answers ShouldHaveLength 2

  - name: Second poll instance should have 1 answer
    steps:
      - type: http
        method: GET
        url: "{{.api}}/polls/{{.poll_id}}/instances/2"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson.answers ShouldHaveLength 1
